<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="title" content="ëƒ¥ìŠë­ íŒŒí‹° ì˜ˆì•½íŒ" />
    <meta name="description" content="ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹°Â·ì‹¤ì‹œê°„ ì°¸ê°€/ì·¨ì†ŒÂ·ì£¼ê°„ ë³´ê¸°" />
    <title>ëƒ¥ìŠë­ íŒŒí‹° ì˜ˆì•½íŒ</title>
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ëƒ¥ìŠë­ íŒŒí‹° ì˜ˆì•½íŒ" />
    <meta property="og:description" content="ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹°Â·ì‹¤ì‹œê°„ ì°¸ê°€/ì·¨ì†ŒÂ·ì£¼ê°„ ë³´ê¸°" />
    <meta property="og:url" content="https://nyangguild.github.io/party-reservation/" />

    <!-- ê¸°ì¡´ CSS -->
    <link rel="stylesheet" type="text/css" href="party.css" />

    <!-- ì¶”ê°€: ì „ì²´ ë°°ê²½ë§Œ ì–´ë‘¡ê²Œ -->
    <style>
      body {
        background: #2a2a2a;  /* í°ìƒ‰ ëŒ€ì‹  ì§™ì€ íšŒìƒ‰ */
        color: #111;          /* ê¸°ë³¸ ê¸€ì”¨ ìƒ‰ìƒì€ ìœ ì§€ */
      }

      /* í—¤ë” ë°°ê²½ í°ë¹› ì œê±° */
      .header {
        background: transparent;
      }

      /* ì¹´ë“œ ì—¬ë°± ëŒ€ë¹„ ìœ ì§€ */
      .card {
        background: #fff;   /* ì¹´ë“œ ë‚´ë¶€ëŠ” ê·¸ëŒ€ë¡œ ë°ê²Œ */
      }
    </style>
</head>

<body>
    <div id="wrap">
        <header class="header">
            <h1>ì£¼ê°„ íŒŒí‹° ì˜ˆì•½íŒ <span class="hint"><i>ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹° Â· ì£¼ê°„ ë³´ê¸°</i></span></h1>
        </header>
        <div id="container">
            <div class="credit"><span class="pill">ë©”ì´ë¸</span>
                <p><b>â€˜ëƒ¥ìŠë­â€™</b>ì˜ <b>ëƒ¥ë² ë¦¬</b>ê°€ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="card">
                <div class="row">
                    <div class="field nick-row">
                        <label for="nick" class="secTit">ë³„ëª…/ë‹‰ë„¤ì„</label>
                        <div class="nameBox">
                            <input id="nick" placeholder="ì¸ê²Œì„ ë‹‰ë„¤ì„" />
                            <button id="saveNick" class="primary" aria-label="ë‹‰ë„¤ì„ ì €ì¥">
                                <span class="lbl-full hide">ë‹‰ë„¤ì„ ì €ì¥</span>
                                <span class="lbl-short" aria-hidden="true">ì €ì¥</span>
                            </button>
                        </div>
                    </div>
                    <div class="field hide" id="topWeekControls">
                        <label>ì£¼ê°„ ì‹œì‘ì¼(ì›”ìš”ì¼)</label>
                        <input type="date" id="weekStart" class="no-native-icon" />
                        <button id="goWeek" class="primary">í•´ë‹¹ ì£¼ ë³´ê¸°</button>
                        <button id="btnWeekPicker" class="picker-btn icon-btn" title="ì£¼ê°„ ì„ íƒ">ğŸ“…</button>
                    </div>
                </div>
                <div class="hintTxt">ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ë©´ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì°¸ê°€/ì·¨ì†Œê°€ ë©ë‹ˆë‹¤. ì´ í™”ë©´ì€ ì„ íƒí•œ â€˜í•´ë‹¹ ì£¼â€™ì˜ íŒŒí‹°ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
            </div>
            <!-- íŒŒí‹° ìƒì„± -->
            <div class="card">
                <div class="form-grid">
                    <div class="rowline">
                        <strong class="secTit">íŒŒí‹° ìƒì„±</strong>
                    </div>
                    <!-- 1ì¤„: ë‚ ì§œ / ì‹œê°„ -->
                    <div class="rowline">
                        <div class="field">
                            <label>ë‚ ì§œ</label>
                            <input type="date" id="eventDate" class="no-native-icon" />
                            <button id="btnDatePicker" class="picker-btn icon-btn" title="ë‚ ì§œ ì„ íƒ">ğŸ“…</button>
                        </div>
                        <div class="field">
                            <label>ì‹œê°„</label>
                            <select id="ampmSelect" class="no-native-icon">
                                <option value="AM">ì˜¤ì „</option>
                                <option value="PM">ì˜¤í›„</option>
                            </select>
                            <select id="hourSelect" class="no-native-icon"></select>
                            <select id="minSelect" class="no-native-icon"></select>
                            <button id="btnTimePicker" class="picker-btn icon-btn" title="ì‹œê°„ ì„ íƒ">ğŸ•’</button>
                        </div>
                        <div class="grow"></div>
                    </div>
                    <!-- 2ì¤„: ë¶„ë¥˜ / ë˜ì „ / ë‚œì´ë„ -->
                    <div class="rowline">
                        <div class="field">
                            <label>ë¶„ë¥˜</label>
                            <select id="catSelect">
                                <option value="abyss">ì–´ë¹„ìŠ¤</option>
                                <option value="raid">ë ˆì´ë“œ</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>ë˜ì „</label>
                            <select id="dungeonSelect"></select>
                        </div>
                        <div class="field">
                            <label>ë‚œì´ë„</label>
                            <select id="eventDiff"></select>
                        </div>
                    </div>
                    <button id="createEvent" class="primary success">íŒŒí‹° ìƒì„±</button>
                    <!-- 3ì¤„: ì„¤ëª… -->
                    <div class="rowline">
                        <div class="hintTxt">ì •ì›ì€ ë˜ì „ì— ë”°ë¼ ìë™ ì„¤ì •ë©ë‹ˆë‹¤: ì–´ë¹„ìŠ¤(ë§ˆìŠ¤ ë“±) 4 / ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨ 8 / ì„œíë²„ìŠ¤ 4</div>
                    </div>
                </div>
            </div>
            <!-- ì£¼ê°„ íŒŒí‹° ëª©ë¡ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ) -->
            <div class="card">
                <div class="row section-head" style="justify-content:space-between; margin-bottom:8px">
                    <strong class="secTit">ì´ë²ˆ ì£¼ íŒŒí‹° ëª©ë¡</strong>
                    <div class="row calrendarSet">
                        <div class="dateBox">
                            <input type="date" id="weekStart2" class="no-native-icon" />
                            <button id="btnWeekPicker2" class="picker-btn icon-btn" title="ë‚ ì§œ ì„ íƒ">ğŸ“…</button>
                        </div>
                        <div class="setBox">
                            <button id="prevWeek" class="picker-btn icon-btn" title="ì´ì „ ì£¼"><span>ì´ì „</span></button>
                            <button id="goWeek2" class="primary">ì´ë²ˆ ì£¼ ë³´ê¸°</button>
                            <button id="nextWeek" class="picker-btn icon-btn next" title="ë‹¤ìŒ ì£¼"><span>ë‹¤ìŒ</span></button>
                            <span class="muted" id="weekLabel"></span>
                        </div>
                    </div>
                </div>
                <div id="weekStrip" class="week-strip"></div>
                <div id="eventsContainer" class="events"></div>
                <div class="noData" id="emptyHint">í•´ë‹¹ ìš”ì¼ì—ëŠ” ì•„ì§ ìƒì„±ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</div>
            </div>
            <p class="copy">Â© 2025. nyangchelin. All rights reserved.</p>
        </div>
        <script type="module">
            // ğŸ”‘ Firebase êµ¬ì„±
            const firebaseConfig = {
                apiKey: "AIzaSyBa0Lo3qikOS495BmX4JAew63QF7h5FnC0",
                authDomain: "party-reservation.firebaseapp.com",
                projectId: "party-reservation",
                storageBucket: "party-reservation.firebasestorage.app",
                messagingSenderId: "566891379159",
                appId: "1:566891379159:web:8d69d4996dd859a295f392",
                measurementId: "G-XQBDVLWEJD"
            };

            import {
                initializeApp
            } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
            import {
                getAuth,
                signInAnonymously,
                onAuthStateChanged
            } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
            import {
                getFirestore,
                doc,
                getDoc,
                setDoc,
                onSnapshot,
                runTransaction,
                getDocs,
                collection
            } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // ---------- ìƒìˆ˜/ìš”ì†Œ ----------
            const DAYS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

            const nickEl = document.getElementById('nick');
            const saveNickBtn = document.getElementById('saveNick');
            const weekStartEl = document.getElementById('weekStart');
            const goWeekBtn = document.getElementById('goWeek');
            const btnWeekPicker = document.getElementById('btnWeekPicker');
            const weekLabel = document.getElementById('weekLabel');
            const weekStart2 = document.getElementById('weekStart2');
            const goWeek2 = document.getElementById('goWeek2');
            const btnWeekPicker2 = document.getElementById('btnWeekPicker2');
            const prevWeek = document.getElementById('prevWeek');
            const nextWeek = document.getElementById('nextWeek');

            const eventDateEl = document.getElementById('eventDate');
            const btnDatePicker = document.getElementById('btnDatePicker');
            const ampmEl = document.getElementById('ampmSelect');
            const hourEl = document.getElementById('hourSelect');
            const minEl = document.getElementById('minSelect');
            const btnTimePicker = document.getElementById('btnTimePicker');

            const catEl = document.getElementById('catSelect');
            const dungeonEl = document.getElementById('dungeonSelect');
            const eventDiffEl = document.getElementById('eventDiff');
            const createEventBtn = document.getElementById('createEvent');
            // íŒŒí‹° ìƒì„± ë²„íŠ¼ ì¬ë°°ì¹˜ ëŒ€ìƒ í–‰ ì°¾ê¸°
            const _rows = document.querySelectorAll('.form-grid .rowline');
            const DATE_ROW = _rows[1]; // ë‚ ì§œ/ì‹œê°„ ì¤„
            const CAT_ROW = _rows[2]; // ë¶„ë¥˜/ë˜ì „/ë‚œì´ë„ ì¤„

            const eventsContainer = document.getElementById('eventsContainer');
            const emptyHint = document.getElementById('emptyHint');
            const weekStrip = document.getElementById('weekStrip');

            // ë¶„ë¥˜/ë˜ì „/ë‚œì´ë„ í”„ë¦¬ì…‹
            const DUNGEONS = {
                abyss: [{
                    id: 'mas',
                    name: 'ë§ˆìŠ¤ ë˜ì „'
                }],
                raid: [{
                    id: 'glas',
                    name: 'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨'
                }, {
                    id: 'succ',
                    name: 'ì„œíë²„ìŠ¤'
                }]
            };
            const DIFFS = {
                mas: ['ì…ë¬¸', 'ì–´ë ¤ì›€', 'ë§¤ìš°ì–´ë ¤ì›€', 'ì§€ì˜¥1', 'ì§€ì˜¥2', 'ì§€ì˜¥3', 'ì§€ì˜¥4', 'ì§€ì˜¥5', 'ì§€ì˜¥6', 'ì§€ì˜¥7', 'ì…ë¬¸~ì§€ì˜¥6'],
                glas: ['ì…ë¬¸', 'ì–´ë ¤ì›€', 'ë§¤ìš°ì–´ë ¤ì›€'],
                succ: ['ì–´ë ¤ì›€']
            };
            const CAP = (dg) => dg === 'glas' ? 8 : 4;

            // ë¡œì»¬ ì €ì¥ ë‹‰
            nickEl.value = localStorage.getItem('party_nick') || '';

            // ---------- ìœ í‹¸ (KST ê¸°ì¤€ ë‚ ì§œ) ----------
            const pad2 = n => String(n).padStart(2, '0');
            const kstFmt = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const kstYMD = (date = new Date()) => kstFmt.format(date);
            const dateFromYMD = (ymd) => {
                const [y, m, d] = (ymd || '').split('-').map(Number);
                return new Date(y || 1970, (m || 1) - 1, d || 1);
            };

            function todayInKST() {
                return dateFromYMD(kstYMD());
            }

            function mondayOf(date) {
                const d = new Date(date);
                const day = (d.getDay() + 6) % 7;
                d.setDate(d.getDate() - day);
                d.setHours(0, 0, 0, 0);
                return d;
            }

            function weekIdFromDate(d) {
                return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            }

            // ---------- ì´ˆê¸° ì£¼ê°„ (ëŒ€í•œë¯¼êµ­ ì‹œê°„ ê¸°ì¤€) ----------
            const TODAY_KST = todayInKST();
            const defMon = mondayOf(TODAY_KST);
            weekStartEl.value = kstYMD(defMon);
            let CURRENT_WEEK_MON = defMon;
            let CURRENT_WEEK_ID = weekIdFromDate(defMon);
            let CURRENT_USER = null;
            let ACTIVE_DAY = 0;

            // ---------- ì¸ì¦ ----------
            signInAnonymously(auth).catch(e => {
                console.error(e);
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.code);
            });
            onAuthStateChanged(auth, user => {
                if (user) {
                    CURRENT_USER = user;
                    boot();
                }
            });

            // ---------- ë‹‰ë„¤ì„ ì €ì¥ ----------
            saveNickBtn.onclick = () => {
                const v = nickEl.value.trim();
                if (!v) {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                localStorage.setItem('party_nick', v);
                alert('ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ');
            };

            // ---------- í”½ì»¤ ë²„íŠ¼ ----------
            const safeShow = (el) => {
                if (el.showPicker) el.showPicker();
                else el.focus();
            };
            btnWeekPicker.onclick = () => safeShow(weekStartEl);
            btnWeekPicker2.onclick = () => safeShow(weekStart2);
            btnDatePicker.onclick = () => safeShow(eventDateEl);
            btnTimePicker.onclick = () => hourEl.focus();

            // ---------- ì£¼ê°„ ì´ë™ ----------
            goWeekBtn.onclick = () => {
                const picked = weekStartEl.valueAsDate;
                if (!picked) {
                    alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                setWeekByDate(picked);
            };
            goWeek2.onclick = () => {
                setWeekByDate(todayInKST());
            };
            prevWeek.onclick = () => {
                const d = new Date(CURRENT_WEEK_MON);
                d.setDate(d.getDate() - 7);
                setWeekByDate(d);
            };
            nextWeek.onclick = () => {
                const d = new Date(CURRENT_WEEK_MON);
                d.setDate(d.getDate() + 7);
                setWeekByDate(d);
            };

            function setWeekByDate(dateObj) {
                CURRENT_WEEK_MON = mondayOf(dateObj);
                CURRENT_WEEK_ID = weekIdFromDate(CURRENT_WEEK_MON);
                weekStartEl.valueAsDate = CURRENT_WEEK_MON;
                if (weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
                boot();
            }

            // ---------- ë¶„ë¥˜â†’ë˜ì „â†’ë‚œì´ë„ ì—°ë™ ----------
            function refreshDungeons() {
                const cat = catEl.value;
                dungeonEl.innerHTML = '';
                for (const d of DUNGEONS[cat]) {
                    const o = document.createElement('option');
                    o.value = d.id;
                    o.textContent = d.name;
                    dungeonEl.appendChild(o);
                }
                refreshDiffs();
            }

            function refreshDiffs() {
                const dg = dungeonEl.value;
                eventDiffEl.innerHTML = '';
                (DIFFS[dg] || []).forEach(x => {
                    const o = document.createElement('option');
                    o.value = x;
                    o.textContent = x;
                    eventDiffEl.appendChild(o);
                });
            }
            catEl.addEventListener('change', refreshDungeons);
            dungeonEl.addEventListener('change', refreshDiffs);
            refreshDungeons();

            // ---------- ì£¼ê°„ ë²”ìœ„ë¡œ íŒŒí‹° ìƒì„± ë‚ ì§œ ì œí•œ ----------
            function syncEventDateRange() {
                const min = new Date(CURRENT_WEEK_MON);
                const max = new Date(CURRENT_WEEK_MON);
                max.setDate(max.getDate() + 6);
                const minStr = `${min.getFullYear()}-${pad2(min.getMonth()+1)}-${pad2(min.getDate())}`;
                const maxStr = `${max.getFullYear()}-${pad2(max.getMonth()+1)}-${pad2(max.getDate())}`;
                eventDateEl.min = minStr;
                eventDateEl.max = maxStr;
                if (!eventDateEl.value) {
                    const todayStr = kstYMD();
                    eventDateEl.value = (todayStr >= minStr && todayStr <= maxStr) ? todayStr : minStr;
                }
            }

            // ì‹œê°„ ì…€ë ‰íŠ¸(ì˜¤ì „/ì˜¤í›„, ì‹œ, ë¶„) ì´ˆê¸°í™”
            function initTimeSelects(defaultHHMM = '20:00') {
                // ì‹œ: 01~12
                hourEl.innerHTML = '';
                for (let h = 1; h <= 12; h++) {
                    const o = document.createElement('option');
                    o.value = pad2(h);
                    o.textContent = pad2(h);
                    hourEl.appendChild(o);
                }
                // ë¶„: 00,05,10,...55
                minEl.innerHTML = '';
                for (let m = 0; m < 60; m += 5) {
                    const o = document.createElement('option');
                    o.value = pad2(m);
                    o.textContent = pad2(m);
                    minEl.appendChild(o);
                }
                setTimeSelectFromValue(defaultHHMM);
            }

            function setTimeSelectFromValue(hhmm) {
                const parts = (hhmm || '20:00').split(':');
                let H = parseInt(parts[0] || '20', 10);
                let M = parseInt(parts[1] || '0', 10);
                if (Number.isNaN(H)) H = 20;
                if (Number.isNaN(M)) M = 0;
                const isPM = H >= 12;
                const h12 = ((H + 11) % 12) + 1;
                ampmEl.value = isPM ? 'PM' : 'AM';
                hourEl.value = pad2(h12);
                minEl.value = pad2(Math.round(M / 5) * 5 % 60);
            }

            function getTimeValue() {
                const ampm = ampmEl.value;
                let h = parseInt(hourEl.value || '12', 10);
                let m = parseInt(minEl.value || '0', 10);
                if (ampm === 'PM' && h < 12) h += 12;
                if (ampm === 'AM' && h === 12) h = 0;
                return `${pad2(h)}:${pad2(m)}`;
            }
            initTimeSelects('20:00');

            // ---------- íŒŒí‹° ìƒì„± ----------
            createEventBtn.onclick = async () => {
                const nick = (nickEl.value || '').trim();
                if (!nick) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.');
                    return;
                }
                const sel = new Date(eventDateEl.value);
                sel.setHours(0, 0, 0, 0);
                const dIdx = Math.floor((sel - CURRENT_WEEK_MON) / 86400000);
                if (dIdx < 0 || dIdx > 6) {
                    alert('ì„ íƒí•œ ë‚ ì§œê°€ í˜„ì¬ ì£¼ê°„(ì›”~ì¼) ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ìƒë‹¨ ' + 'í•´ë‹¹ ì£¼ ë³´ê¸°' + 'ë¡œ ì£¼ê°„ì„ ë¨¼ì € ë§ì¶°ì£¼ì„¸ìš”.');
                    return;
                }
                const time = getTimeValue();
                const cat = catEl.value;
                const dg = dungeonEl.value;
                const diff = eventDiffEl.value;
                const cap = CAP(dg);
                const sid = `${dIdx}-${time}`;

                const slotRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(slotRef);
                    let data = snap.exists() ? snap.data() : {
                        events: []
                    };
                    const events = Array.isArray(data.events) ? data.events : [];
                    if (events.length >= 3) throw new Error('í•´ë‹¹ ì‹œê°„ëŒ€ì˜ íŒŒí‹°ê°€ ì´ë¯¸ 3ê°œì…ë‹ˆë‹¤.');
                    // ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ë°©ì§€
                    for (const e of events) {
                        e.members = (e.members || []).filter(m => m.uid !== CURRENT_USER.uid);
                    }
                    const id = 'e' + Date.now() + Math.random().toString(36).slice(2, 7);
                    events.push({
                        id,
                        cat,
                        dg,
                        diff,
                        cap,
                        title: `${nick}ì˜ íŒŒí‹°`,
                        hostUid: CURRENT_USER.uid,
                        hostNick: nick,
                        members: [{
                            uid: CURRENT_USER.uid,
                            nick
                        }],
                        createdAt: Date.now()
                    });
                    data.events = events;
                    tx.set(slotRef, data);
                }).catch(e => alert(e.message));

                // ì£¼ê°„ íƒ€ì„ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ)
                const weekRef = doc(db, 'weeks', CURRENT_WEEK_ID);
                const wSnap = await getDoc(weekRef);
                const times = wSnap.exists() ? (wSnap.data().times || []) : [];
                if (!times.includes(time)) {
                    await setDoc(weekRef, {
                        times: [...times, time]
                    }, {
                        merge: true
                    });
                }
            };

            // ---------- ì‹¤ì‹œê°„ êµ¬ë… & ë Œë” ----------
            let unsubWeek = null;
            let slotUnsubs = [];
            const SLOT_DATA = new Map();

            function unsubAll() {
                if (unsubWeek) try {
                    unsubWeek();
                } catch (e) {}
                unsubWeek = null;
                for (const u of slotUnsubs) try {
                    u();
                } catch (e) {}
                slotUnsubs = [];
            }

            function boot() {
                // ì´ˆê¸° ë²„íŠ¼ ë ˆì´ì•„ì›ƒ ì¡°ì •
                reflowCreateButton();
                unsubAll();
                const sun = new Date(CURRENT_WEEK_MON);
                sun.setDate(CURRENT_WEEK_MON.getDate() + 6);
                weekLabel.textContent = `${CURRENT_WEEK_MON.getFullYear()}-${pad2(CURRENT_WEEK_MON.getMonth()+1)}-${pad2(CURRENT_WEEK_MON.getDate())} ~ ${sun.getFullYear()}-${pad2(sun.getMonth()+1)}-${pad2(sun.getDate())}`;
                if (weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
                syncEventDateRange();
                ACTIVE_DAY = defaultActiveDayForWeek();
                renderWeekStrip();

                const wRef = doc(db, 'weeks', CURRENT_WEEK_ID);
                setDoc(wRef, {
                    times: []
                }, {
                    merge: true
                });
                // ë¹ˆ times ìë™ ë³µêµ¬(ê¸°ì¡´ ìŠ¬ë¡¯ì—ì„œ ìˆ˜ì§‘)
                hydrateTimesIfMissing(CURRENT_WEEK_ID);
                unsubWeek = onSnapshot(wRef, (snap) => {
                    const times = snap.exists() ? (snap.data().times || []) : [];
                    if (!times || times.length === 0) {
                        hydrateTimesIfMissing(CURRENT_WEEK_ID);
                    }
                    attachSlotListeners(times);
                    reflowCreateButton();
                });
            }

            async function hydrateTimesIfMissing(weekId) {
                try {
                    const wRef = doc(db, 'weeks', weekId);
                    const wSnap = await getDoc(wRef);
                    const times = wSnap.exists() ? (wSnap.data().times || []) : [];
                    if (times.length > 0) return;
                    const snaps = await getDocs(collection(db, 'weeks', weekId, 'slots'));
                    const found = new Set();
                    snaps.forEach(d => {
                        const id = d.id;
                        const parts = id.split('-');
                        if (parts.length >= 2) found.add(parts.slice(1).join('-'));
                    });
                    if (found.size > 0) {
                        await setDoc(wRef, {
                            times: [...found].sort()
                        }, {
                            merge: true
                        });
                    }
                } catch (e) {
                    console.warn('hydrateTimesIfMissing failed', e);
                }
            }

            async function pruneWeekTimeIfEmpty(weekId, time) {
                try {
                    // í•´ë‹¹ ì£¼ì˜ ê°™ì€ timeì— ëŒ€í•´ ìš”ì¼ 0..6 ìŠ¬ë¡¯ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                    for (let d = 0; d < 7; d++) {
                        const sRef = doc(db, 'weeks', weekId, 'slots', `${d}-${time}`);
                        const sSnap = await getDoc(sRef);
                        if (sSnap.exists()) return; // ì•„ì§ ë‚¨ì•„ìˆìŒ
                    }
                    // ì „ë¶€ ì—†ìœ¼ë©´ week.timesì—ì„œ ì œê±°
                    const wRef = doc(db, 'weeks', weekId);
                    const wSnap = await getDoc(wRef);
                    if (!wSnap.exists()) return;
                    const times = wSnap.data().times || [];
                    const next = times.filter(t => t !== time);
                    await setDoc(wRef, {
                        times: next
                    }, {
                        merge: true
                    });
                } catch (e) {
                    console.warn('pruneWeekTimeIfEmpty failed', e);
                }
            }

            function attachSlotListeners(times) {
                for (const u of slotUnsubs) try {
                    u();
                } catch (e) {}
                slotUnsubs = [];
                SLOT_DATA.clear();
                if (!times || times.length === 0) {
                    renderWeekStrip();
                    renderEvents();
                    return;
                }
                for (let d = 0; d < 7; d++) {
                    for (const t of [...times].sort()) {
                        const sid = `${d}-${t}`;
                        const sRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
                        const unsub = onSnapshot(sRef, (snap) => {
                            const data = snap.exists() ? snap.data() : {
                                events: []
                            };
                            SLOT_DATA.set(`${d}|${t}`, data.events || []);
                            renderWeekStrip();
                            renderEvents();
                        });
                        slotUnsubs.push(unsub);
                    }
                }
            }

            function labelCat(c) {
                return c === 'abyss' ? 'ì–´ë¹„ìŠ¤' : 'ë ˆì´ë“œ';
            }

            function labelDungeon(id) {
                return id === 'mas' ? 'ë§ˆìŠ¤ ë˜ì „' : (id === 'glas' ? 'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨' : 'ì„œíë²„ìŠ¤');
            }

            function dungeonClass(id) {
                return id === 'mas' ? 'dg-mas' : (id === 'glas' ? 'dg-glas' : 'dg-succ');
            }

            function diffClass(name) {
                const n = String(name || '').replace(/ /g, '');
                if (n === 'ì…ë¬¸') return 'diff-easy';
                if (n === 'ì–´ë ¤ì›€') return 'diff-hard';
                if (n === 'ë§¤ìš°ì–´ë ¤ì›€') return 'diff-veryhard';
                if (n === 'ì…ë¬¸~ì§€ì˜¥6' || n === 'ì…ë¶„~ì§€6') return 'diff-pink';
                if (/^ì§€ì˜¥[0-9]+$/.test(n)) return 'diff-veryhard';
                return '';
            }

            function defaultActiveDayForWeek() {
                const mon = CURRENT_WEEK_MON;
                const sun = new Date(mon);
                sun.setDate(mon.getDate() + 6);
                const today = todayInKST();
                if (today >= mon && today <= sun) {
                    return Math.floor((today - mon) / 86400000);
                }
                return 0;
            }

            function summarizeByDay() {
                const res = Array.from({
                    length: 7
                }, () => ({
                    total: 0,
                    abyss: 0,
                    raid: 0,
                    mine: false
                }));
                for (const [key, events] of SLOT_DATA.entries()) {
                    const [ddStr] = key.split('|');
                    const dd = Number(ddStr);
                    if (!Array.isArray(events)) continue;
                    for (const ev of events) {
                        const cat = ev.cat || (ev.type === 'abyss' ? 'abyss' : 'raid');
                        if (cat === 'abyss') res[dd].abyss++;
                        else res[dd].raid++;
                        res[dd].total++;
                        if (CURRENT_USER && (ev.members || []).some(m => m.uid === CURRENT_USER.uid)) res[dd].mine = true;
                    }
                }
                return res;
            }

            // ===== ë ˆì´ì•„ì›ƒ ìœ í‹¸: ëª¨ë°”ì¼ì—ì„œ íŒŒí‹°ìƒì„± ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • =====
            function reflowCreateButton() {
                const w = window.innerWidth || document.documentElement.clientWidth;
                if (w <= 520) {
                    if (createEventBtn.parentElement !== CAT_ROW) {
                        CAT_ROW.appendChild(createEventBtn);
                    }
                    createEventBtn.classList.add('ml-auto');
                    if (w <= 360) {
                        createEventBtn.classList.add('mobile-fullwidth');
                    } else {
                        createEventBtn.classList.remove('mobile-fullwidth');
                    }
                } else {
                    if (createEventBtn.parentElement !== DATE_ROW) {
                        DATE_ROW.appendChild(createEventBtn);
                    }
                    createEventBtn.classList.remove('ml-auto', 'mobile-fullwidth');
                }
            }
            let __rfTimer = null;
            window.addEventListener('resize', () => {
                clearTimeout(__rfTimer);
                __rfTimer = setTimeout(reflowCreateButton, 150);
            });

            function renderWeekStrip() {
                if (!weekStrip) return;
                const summary = summarizeByDay();
                weekStrip.innerHTML = '';
                for (let d = 0; d < 7; d++) {
                    const dateObj = new Date(CURRENT_WEEK_MON);
                    dateObj.setDate(CURRENT_WEEK_MON.getDate() + d);
                    const dateStr = `${pad2(dateObj.getMonth()+1)}/${pad2(dateObj.getDate())}`;
                    const {
                        total,
                        abyss,
                        raid,
                        mine
                    } = summary[d];
                    const el = document.createElement('div');
                    el.setAttribute('role', 'button');
                    el.tabIndex = 0;
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            setActiveDay(d);
                        }
                    });
                    el.className = 'ws-day' + (d === ACTIVE_DAY ? ' active' : '') + (mine ? ' mine' : '');
                    el.innerHTML = `
              <div class="head"><span>${DAYS[d]}</span><span class="date">${dateStr}</span></div>
              <div class="total">${total}</div>
              <div class="mini-badges">
                <span class="mini-badge abyss">ì–´ë¹„ìŠ¤ ${abyss}</span>
                <span class="mini-badge raid">ë ˆì´ë“œ ${raid}</span>
                ${mine?'<span class="dot" title="ë‚´ íŒŒí‹° ìˆìŒ">ğŸ’›</span>':''}
              </div>`;
                    el.addEventListener('click', () => setActiveDay(d));
                    weekStrip.appendChild(el);
                }
            }

            function setActiveDay(d) {
                ACTIVE_DAY = d;
                renderWeekStrip();
                renderEvents();
            }

            function renderEvents() {
                eventsContainer.innerHTML = '';
                const d = ACTIVE_DAY;
                const list = [];
                for (const [key, events] of SLOT_DATA.entries()) {
                    const [dd, time] = key.split('|');
                    if (Number(dd) === d && Array.isArray(events) && events.length > 0) {
                        list.push({
                            time,
                            events
                        });
                    }
                }
                if (list.length === 0) {
                    //emptyHint.textContent = 'í•´ë‹¹ ìš”ì¼ì—ëŠ” ì•„ì§ ìƒì„±ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.';
                    emptyHint.style.display = 'block';
                    return;
                }
                emptyHint.style.display = 'none';
                list.sort((a, b) => a.time.localeCompare(b.time));

                const dayEl = document.createElement('section');
                dayEl.className = 'day';
                const dateObj = new Date(CURRENT_WEEK_MON);
                dateObj.setDate(CURRENT_WEEK_MON.getDate() + d);
                const dateStr = `${pad2(dateObj.getMonth()+1)}/${pad2(dateObj.getDate())}`;
                dayEl.innerHTML = `<div class="head"><h2>${DAYS[d]}ìš”ì¼ <span class="date">${dateStr}</span></h2></div>`;
                const slotsEl = document.createElement('div');
                slotsEl.className = 'slots';

                for (const item of list) {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'slot';
                    slotEl.innerHTML = `<div class="time">${item.time}</div>`;
                    for (const ev of item.events) {
                        const cat = ev.cat || (ev.type === 'abyss' ? 'abyss' : 'raid');
                        const dg = ev.dg || (ev.type === 'abyss' ? 'mas' : (ev.type === 'glas' ? 'glas' : 'succ'));
                        const diffCls = diffClass(ev.diff);
                        const full = (ev.members?.length || 0) >= (ev.cap || 4);
                        const host = ev.hostNick || (ev.members?. [0]?.nick || 'íŒŒí‹°');
                        const title = ev.title || `${host}ì˜ íŒŒí‹°`;
                        const isMine = !!(CURRENT_USER && (ev.members || []).some(m => m.uid === CURRENT_USER.uid));
                        const names = (ev.members || []).map(m => `<span class="chip">${escapeHtml(m.nick)}</span>`).join('') || '<span class="muted">(ë¹„ì–´ìˆìŒ)</span>';
                        const evEl = document.createElement('div');
                        evEl.className = 'event' + (full ? ' full' : '') + (isMine ? ' mine' : '');
                        evEl.innerHTML = `
                <div>
                  <div class="label">
                    <span class="badge ${cat==='abyss'?'cat-abyss':'cat-raid'}">${labelCat(cat)}</span>
                    <span class="badge ${dungeonClass(dg)}">${labelDungeon(dg)}</span>
                    <span class="badge diff ${diffCls}">${ev.diff}</span>
                    <span class="count">${(ev.members?.length||0)}/${ev.cap||4}</span>
                    ${isMine ? '<span class="badge mine">ë‚´ íŒŒí‹°</span>' : ''}
                  </div>
                  <div class="titlebox"><div class="names">${names}</div><div class="title">${escapeHtml(title)}</div>
                  </div>
                </div>
                <div class="btns">
                  <button class="btn-join">ì°¸ê°€</button>
                  <button class="btn-leave">ì·¨ì†Œ</button>
                </div>`;
                        const joinBtn = evEl.querySelector('.btn-join');
                        const leaveBtn = evEl.querySelector('.btn-leave');
                        joinBtn.addEventListener('click', () => {
                            const nick = (nickEl.value || '').trim();
                            if (!nick) {
                                alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.');
                                return;
                            }
                            const sid = `${d}-${item.time}`;
                            joinEvent(CURRENT_WEEK_ID, sid, ev.id, ev.cap || 4);
                        });
                        leaveBtn.addEventListener('click', () => {
                            const sid = `${d}-${item.time}`;
                            leaveEvent(CURRENT_WEEK_ID, sid);
                        });
                        if (isMine) {
                            joinBtn.disabled = true;
                            joinBtn.style.background = '#ededed';
                            joinBtn.style.color = '#ccc';
                            joinBtn.title = 'ì´ë¯¸ ì°¸ê°€í•œ íŒŒí‹°ì…ë‹ˆë‹¤';
                        }
                        if (full && !isMine) {
                            joinBtn.disabled = true;
                            joinBtn.style.background = '#ededed';
                            joinBtn.style.color = '#ccc';
                            joinBtn.title = 'ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤';
                        }
                        if (ev.hostUid && CURRENT_USER && ev.hostUid === CURRENT_USER.uid) {
                            const delBtn = document.createElement('button');
                            delBtn.className = 'btn-delete';
                            delBtn.textContent = 'ì‚­ì œ';
                            evEl.querySelector('.btns').appendChild(delBtn);
                            delBtn.addEventListener('click', () => {
                                alert('íŒŒí‹°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                                const sid = `${d}-${item.time}`;
                                deleteEvent(CURRENT_WEEK_ID, sid, ev.id);
                            });
                        }
                        slotEl.appendChild(evEl);
                    }
                    slotsEl.appendChild(slotEl);
                }
                dayEl.appendChild(slotsEl);
                eventsContainer.appendChild(dayEl);
            }

            // ì•ˆì „í•œ HTML ì´ìŠ¤ì¼€ì´í”„
            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, function(ch) {
                    if (ch === '&') return '&amp;';
                    if (ch === '<') return '&lt;';
                    if (ch === '>') return '&gt;';
                    if (ch === '"') return '&quot;';
                    if (ch === "'") return '&#39;';
                    return ch;
                });
            }

            async function joinEvent(weekId, sid, eventId, cap) {
                const nick = (nickEl.value || '').trim();
                if (!nick) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.');
                    return;
                }
                const ref = doc(db, 'weeks', weekId, 'slots', sid);
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(ref);
                    if (!snap.exists()) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    const data = snap.data();
                    let events = data.events || [];
                    for (const e of events) {
                        e.members = (e.members || []).filter(m => m.uid !== CURRENT_USER.uid);
                    }
                    const target = events.find(e => e.id === eventId);
                    if (!target) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    if ((target.members?.length || 0) >= (target.cap || cap)) throw new Error('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
                    target.members = [...(target.members || []), {
                        uid: CURRENT_USER.uid,
                        nick
                    }];
                    events = events.filter(e => (e.members?.length || 0) > 0);
                    if (events.length === 0) {
                        tx.delete(ref);
                    } else {
                        tx.set(ref, {
                            events
                        }, {
                            merge: true
                        });
                    }
                }).catch(e => alert(e.message));
                const time = sid.split('-').slice(1).join('-');
                await pruneWeekTimeIfEmpty(weekId, time);
            }

            async function leaveEvent(weekId, sid) {
                const ref = doc(db, 'weeks', weekId, 'slots', sid);
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(ref);
                    if (!snap.exists()) return;
                    let events = (snap.data().events || []);
                    let touched = false;
                    for (const e of events) {
                        const before = e.members || [];
                        const after = before.filter(m => m.uid !== CURRENT_USER.uid);
                        if (after.length !== before.length) {
                            e.members = after;
                            touched = true;
                        }
                    }
                    events = events.filter(e => (e.members?.length || 0) > 0);
                    if (!touched && events.length > 0) return;
                    if (events.length === 0) {
                        tx.delete(ref);
                    } else {
                        tx.set(ref, {
                            events
                        }, {
                            merge: true
                        });
                    }
                }).catch(e => console.warn(e));
                const time = sid.split('-').slice(1).join('-');
                await pruneWeekTimeIfEmpty(weekId, time);
            }

            async function deleteEvent(weekId, sid, eventId) {
                const ref = doc(db, 'weeks', weekId, 'slots', sid);
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(ref);
                    if (!snap.exists()) return;
                    let events = (snap.data().events || []).filter(e => e.id !== eventId);
                    if (events.length === 0) {
                        tx.delete(ref);
                    } else {
                        tx.set(ref, {
                            events
                        }, {
                            merge: true
                        });
                    }
                }).catch(e => alert(e.message));
                const time = sid.split('-').slice(1).join('-');
                await pruneWeekTimeIfEmpty(weekId, time);
            }
        </script>
    </div>
</body></html>


