<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì£¼ê°„ íŒŒí‹° ì˜ˆì•½íŒ (ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹°)</title>
  <style>
    :root{
      --bg:#0b0f14;--card:#121821;--muted:#8aa1b2;--accent:#64a9ff;--accentBg:#0e2236;--ok:#2ecc71;--warn:#ffb84d;--danger:#ff6b6b;--line:#1f2a36;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,'Noto Sans KR','Malgun Gothic',sans-serif;background:var(--bg);color:#e6eef5}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .section-head{margin-bottom:14px}
    label{font-size:14px;color:#8aa1b2}
    input,select,button{height:36px;border-radius:10px;border:1px solid var(--line);background:#0f141b;color:#e6eef5;padding:0 10px}
    /* í•˜ëŠ˜ìƒ‰ ê°•ì¡° ìŠ¤íƒ€ì¼ */
    input[type="date"], input[type="time"], select{border-color:var(--accent);background:var(--accentBg)}
    input[type="date"]:focus, input[type="time"]:focus, select:focus{outline:none;box-shadow:0 0 0 3px rgba(100,169,255,.25)}
    /* ê¸°ë³¸ ì•„ì´ì½˜ ìˆ¨ê¹€ + í…ìŠ¤íŠ¸ ìƒ‰ í†µì¼ */
    .no-native-icon::-webkit-calendar-picker-indicator{opacity:0; pointer-events:none}
    .no-native-icon::-webkit-inner-spin-button{display:none}
    .no-native-icon::-webkit-clear-button{display:none}
    .no-native-icon{color:#e6eef5}

    .picker-btn{height:36px;padding:0 10px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#00172e;font-weight:700;cursor:pointer}
    .picker-btn:active{transform:translateY(1px)}

    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#00172e;font-weight:700}
    .hint{font-size:12px;color:#99b2c7}
    .muted{color:#8aa1b2}

    /* íŒŒí‹° ìƒì„± í¼ ë ˆì´ì•„ì›ƒ */
    .form-grid{display:flex;flex-direction:column;gap:10px}
    .rowline{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{display:flex;gap:10px;align-items:center}
    .grow{flex:1}

    /* ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ (ìˆëŠ” ì‹œê°„ë§Œ) */
    .events{display:flex;flex-direction:column;gap:18px}
    .day{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .day>header{display:flex;align-items:center;justify-content:space-between;background:#0f141b;padding:12px;border-bottom:1px solid var(--line)}
    .day>header h2{font-size:15px;margin:0;color:#e6eef5;display:flex;gap:8px;align-items:center}
    .day>header .date{font-size:12px;color:#e6eef5;border:1px solid var(--line);padding:2px 8px;border-radius:999px;background:#0f141b}
    .slots{padding:16px;display:flex;flex-direction:column;gap:14px}
    .slot{border:1px solid var(--line);border-radius:12px;padding:12px}
    .slot .time{font-weight:700;color:#bcd0df;margin-bottom:8px}
    .event{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e131a;margin-top:8px}
    .label{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#cfe3f2}
    .title{font-weight:700;color:#e6eef5;margin:6px 0 4px 0}
    .names{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #294f77;background:linear-gradient(180deg,#10263c,#0b1624);color:#d3e8ff}
    .btns{display:flex;gap:6px}
    .btn-delete{background:#3a1020;color:#ffd6e2;border:1px solid #5a1a31;border-radius:10px;height:36px;padding:0 10px;cursor:pointer}
    .btn-join{background:#21354a;color:#cfe3f2}
    .btn-leave{background:#2a1b1b;color:#ffd5d5;border-color:#512b2b}
    .count{font-weight:700}
    .full{border-color:#3a2a12;background:#1a1410}
    .full .count{color:var(--warn)}

    /* ì¹´í…Œê³ ë¦¬/ë˜ì „ ìƒ‰ìƒ */
    .cat-abyss{border-color:#52d1ff;background:linear-gradient(180deg,#0e2a40,#091b2b);color:#dff6ff}
    .cat-raid{border-color:#ffb84d;background:linear-gradient(180deg,#3a2a12,#1a1410);color:#ffe0a6}
    .dg-mas{border-color:#27d3c1;background:linear-gradient(180deg,#0a2d2b,#081c1b);color:#baf7f0}
    .dg-glas{border-color:#8a7bff;background:linear-gradient(180deg,#241d56,#141132);color:#e8e3ff}
    .dg-succ{border-color:#ff6aa8;background:linear-gradient(180deg,#3a0d25,#210817);color:#ffd6e8}

    /* ë‚œì´ë„ ë±ƒì§€ ìƒ‰ í…Œë§ˆ (í†µì¼) */
    .badge.diff{border-width:2px;font-weight:700}
    .diff-easy{border-color:#9b7bff;background:radial-gradient(60% 100% at 30% 30%, #7a5cff 0%, #3d2a85 70%);color:#efe8ff;box-shadow:0 0 0 1px rgba(155,123,255,.25) inset,0 0 12px rgba(122,92,255,.15) inset}
    .diff-hard{border-color:#ffb84d;background:linear-gradient(180deg,#3a2a12,#1a1410);color:#ffd68a;box-shadow:0 0 0 1px rgba(255,184,77,.2) inset}
    .diff-veryhard{border-color:#ff3b30;background:linear-gradient(180deg,#321112,#21090a);color:#ff8a82;box-shadow:0 0 0 1px rgba(255,59,48,.25) inset}
    .diff-pink{border-color:#ff56c8;background:radial-gradient(65% 100% at 40% 40%, #ff69d4 0%, #5e0f63 70%);color:#ffe9fb;box-shadow:0 0 0 1px rgba(255,86,200,.25) inset}
    #topWeekControls{display:none}
    .credit{margin:4px 0 12px 0;display:flex;align-items:center;gap:8px;color:#cfe3f2;font-size:13px}
    .credit .pill{padding:4px 10px;border-radius:999px;background:linear-gradient(180deg,#0e2a40,#091b2b);border:1px solid #2a435a;color:#a8ddff;font-weight:700}
    .credit strong{color:#ffffff}
    /* ë‚´ê°€ ì°¸ê°€í•œ íŒŒí‹° í•˜ì´ë¼ì´íŠ¸ */
    .event.mine{
      border-color:#69d3ff;
      box-shadow:0 0 0 1px rgba(105,211,255,.25) inset, 0 0 14px rgba(100,169,255,.25);
    }
    .badge.mine{
      border-color:#69d3ff;
      background:linear-gradient(180deg,#0f2b3d,#0b1d2b);
      color:#cfefff;
      font-weight:700;
    }
  </style>
  <meta name="theme-color" content="#0b0f14" />
  <!-- ì¹´ì¹´ì˜¤í†¡ ë¯¸ë¦¬ë³´ê¸°(OG) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ëƒ¥ìŠë­ íŒŒí‹° ì˜ˆì•½íŒ" />
  <meta property="og:description" content="ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹° Â· ì‹¤ì‹œê°„ ì°¸ê°€/ì·¨ì†Œ Â· ì£¼ê°„ ë³´ê¸°" />
  <meta property="og:image" content="og.png" />
</head>
<body>
  <div class="wrap">
    <h1>ì£¼ê°„ íŒŒí‹° ì˜ˆì•½íŒ <span class="hint">(ë™ì‹œê°„ëŒ€ ìµœëŒ€ 3íŒŒí‹° Â· ì£¼ê°„ ë³´ê¸°)</span></h1>
    <div class="credit"><span class="pill">ë©”ì´ë¸</span><span>ì„œë²„ <strong>â€˜ëƒ¥ìŠë­â€™</strong>ì˜ <strong>ëƒ¥ë² ë¦¬</strong>ê°€ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</span></div>

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card">
      <div class="row">
        <div class="field">
          <label>ë³„ëª…/ë‹‰ë„¤ì„</label>
          <input id="nick" placeholder="ì¸ê²Œì„ ë‹‰ë„¤ì„" style="width:180px" />
          <button id="saveNick" class="primary">ë‹‰ë„¤ì„ ì €ì¥</button>
        </div>
        <div class="field" id="topWeekControls">
          <label>ì£¼ê°„ ì‹œì‘ì¼(ì›”ìš”ì¼)</label>
          <input type="date" id="weekStart" class="no-native-icon" />
          <button id="goWeek" class="primary">í•´ë‹¹ ì£¼ ë³´ê¸°</button>
          <button id="btnWeekPicker" class="picker-btn" title="ì£¼ê°„ ì„ íƒ">ğŸ“…</button>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ë©´ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì°¸ê°€/ì·¨ì†Œê°€ ë©ë‹ˆë‹¤. ì´ í™”ë©´ì€ ì„ íƒí•œ â€˜í•´ë‹¹ ì£¼â€™ì˜ íŒŒí‹°ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
    </div>

    <!-- íŒŒí‹° ìƒì„± -->
    <div class="card">
      <div class="form-grid">
        <div class="rowline">
          <strong>íŒŒí‹° ìƒì„±</strong>
        </div>
        <!-- 1ì¤„: ë‚ ì§œ / ì‹œê°„ -->
        <div class="rowline">
          <div class="field">
            <label>ë‚ ì§œ</label>
            <input type="date" id="eventDate" class="no-native-icon" />
            <button id="btnDatePicker" class="picker-btn" title="ë‚ ì§œ ì„ íƒ">ğŸ“…</button>
          </div>
          <div class="field">
            <label>ì‹œê°„</label>
            $1300$2 class="no-native-icon" />
            <button id="btnTimePicker" class="picker-btn" title="ì‹œê°„ ì„ íƒ">ğŸ•’</button>
          </div>
          <div class="grow"></div>
          <button id="createEvent" class="primary">íŒŒí‹° ìƒì„±</button>
        </div>
        <!-- 2ì¤„: ë¶„ë¥˜ / ë˜ì „ / ë‚œì´ë„ -->
        <div class="rowline">
          <div class="field">
            <label>ë¶„ë¥˜</label>
            <select id="catSelect">
              <option value="abyss">ì–´ë¹„ìŠ¤</option>
              <option value="raid">ë ˆì´ë“œ</option>
            </select>
          </div>
          <div class="field">
            <label>ë˜ì „</label>
            <select id="dungeonSelect"></select>
          </div>
          <div class="field">
            <label>ë‚œì´ë„</label>
            <select id="eventDiff"></select>
          </div>
        </div>
        <!-- 3ì¤„: ì„¤ëª… -->
        <div class="rowline"><div class="hint">ì •ì›ì€ ë˜ì „ì— ë”°ë¼ ìë™ ì„¤ì •ë©ë‹ˆë‹¤: ì–´ë¹„ìŠ¤(ë§ˆìŠ¤ ë“±) 4 / ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨ 8 / ì„œíë²„ìŠ¤ 4</div></div>
      </div>
    </div>

    <!-- ì£¼ê°„ íŒŒí‹° ëª©ë¡ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ) -->
    <div class="card">
      <div class="row section-head" style="justify-content:space-between; margin-bottom:8px">
        <strong>ì´ë²ˆ ì£¼ íŒŒí‹° ëª©ë¡</strong>
        <div class="row" style="gap:8px;align-items:center">
          <button id="prevWeek" class="picker-btn" title="ì´ì „ ì£¼">â—€</button>
          <input type="date" id="weekStart2" class="no-native-icon" />
          <button id="btnWeekPicker2" class="picker-btn" title="ë‚ ì§œ ì„ íƒ">ğŸ“…</button>
          <button id="goWeek2" class="primary">ì´ ì£¼ ë³´ê¸°</button>
          <button id="nextWeek" class="picker-btn" title="ë‹¤ìŒ ì£¼">â–¶</button>
          <span class="muted" id="weekLabel"></span>
        </div>
      </div>
      <div id="eventsContainer" class="events"></div>
      <div class="hint" id="emptyHint" style="display:none; margin-top:8px">ì•„ì§ ìƒì„±ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ íŒŒí‹°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</div>
    </div>

    <div class="hint">âš™ï¸ ë¬´ë£Œ í˜¸ìŠ¤íŒ…: GitHub Pages Â· ë°ì´í„°: Firebase Firestore(ìµëª… ë¡œê·¸ì¸)</div>
  </div>

  <script type="module">
    // ğŸ”‘ Firebase êµ¬ì„±
    const firebaseConfig = {
      apiKey: "AIzaSyBa0Lo3qikOS495BmX4JAew63QF7h5FnC0",
      authDomain: "party-reservation.firebaseapp.com",
      projectId: "party-reservation",
      storageBucket: "party-reservation.firebasestorage.app",
      messagingSenderId: "566891379159",
      appId: "1:566891379159:web:8d69d4996dd859a295f392",
      measurementId: "G-XQBDVLWEJD"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getDocs, collection } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- ìƒìˆ˜/ìš”ì†Œ ----------
    const DAYS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

    const nickEl = document.getElementById('nick');
    const saveNickBtn = document.getElementById('saveNick');
    const weekStartEl = document.getElementById('weekStart');
    const goWeekBtn = document.getElementById('goWeek');
    const btnWeekPicker = document.getElementById('btnWeekPicker');
    const weekLabel = document.getElementById('weekLabel');
    const weekStart2 = document.getElementById('weekStart2');
    const goWeek2 = document.getElementById('goWeek2');
    const btnWeekPicker2 = document.getElementById('btnWeekPicker2');
    const prevWeek = document.getElementById('prevWeek');
    const nextWeek = document.getElementById('nextWeek');

    const eventDateEl = document.getElementById('eventDate');
    const btnDatePicker = document.getElementById('btnDatePicker');
    const eventTimeEl = document.getElementById('eventTime');
    const btnTimePicker = document.getElementById('btnTimePicker');

    const catEl = document.getElementById('catSelect');
    const dungeonEl = document.getElementById('dungeonSelect');
    const eventDiffEl = document.getElementById('eventDiff');
    const createEventBtn = document.getElementById('createEvent');

    const eventsContainer = document.getElementById('eventsContainer');
    const emptyHint = document.getElementById('emptyHint');

    // ë¶„ë¥˜/ë˜ì „/ë‚œì´ë„ í”„ë¦¬ì…‹
    const DUNGEONS = {
      abyss: [ {id:'mas', name:'ë§ˆìŠ¤ ë˜ì „'} ],
      raid:  [ {id:'glas', name:'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨'}, {id:'succ', name:'ì„œíë²„ìŠ¤'} ]
    };
    const DIFFS = {
      mas: ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€','ì§€ì˜¥1','ì§€ì˜¥2','ì§€ì˜¥3','ì§€ì˜¥4','ì§€ì˜¥5','ì§€ì˜¥6','ì§€ì˜¥7','ì…ë¬¸~ì§€ì˜¥6'],
      glas: ['ì…ë¬¸','ì–´ë ¤ì›€','ë§¤ìš°ì–´ë ¤ì›€'],
      succ: ['ì–´ë ¤ì›€']
    };
    const CAP = (dg)=> dg==='glas'? 8 : 4;

    // ë¡œì»¬ ì €ì¥ ë‹‰
    nickEl.value = localStorage.getItem('party_nick') || '';

    // ìœ í‹¸ (KST ê¸°ì¤€ ë‚ ì§œ ë„ìš°ë¯¸)
    const pad2=n=>String(n).padStart(2,'0');
    const kstFmt = new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
    const kstYMD = (date=new Date()) => kstFmt.format(date);
    const dateFromYMD = (ymd)=>{ const [y,m,d] = ymd.split('-').map(Number); return new Date(y, m-1, d); };
    function todayInKST(){ return dateFromYMD(kstYMD()); }
    function mondayOf(date){ const d = new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }
    function weekIdFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

    // ì´ˆê¸° ì£¼ê°„ (ëŒ€í•œë¯¼êµ­ ì‹œê°„ ê¸°ì¤€)
    const TODAY_KST = todayInKST();
    const defMon = mondayOf(TODAY_KST);
    weekStartEl.value = kstYMD(defMon);
    let CURRENT_WEEK_MON = defMon;
    let CURRENT_WEEK_ID  = weekIdFromDate(defMon);
    let CURRENT_USER = null;

    // ---------- ì¸ì¦ ----------
    signInAnonymously(auth).catch(e=>{ console.error(e); alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.code); });
    onAuthStateChanged(auth, user=>{ if(user){ CURRENT_USER=user; boot(); } });

    // ---------- ë‹‰ë„¤ì„ ì €ì¥ ----------
    saveNickBtn.onclick = ()=>{
      const v = nickEl.value.trim();
      if(!v){ alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      localStorage.setItem('party_nick', v);
      alert('ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ');
    };

    // ---------- í”½ì»¤ ë²„íŠ¼ ----------
    const safeShow = (el)=>{ if(el.showPicker) el.showPicker(); else el.focus(); };
    btnWeekPicker.onclick = ()=> safeShow(weekStartEl);
    btnWeekPicker2.onclick = ()=> safeShow(weekStart2);
    btnDatePicker.onclick = ()=> safeShow(eventDateEl);
    btnTimePicker.onclick = ()=> safeShow(eventTimeEl);

    // ---------- ì£¼ê°„ ì´ë™ ----------
    goWeekBtn.onclick = ()=>{ const picked = weekStartEl.valueAsDate; if(!picked){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; } setWeekByDate(picked); };
    goWeek2.onclick = ()=>{ const picked = weekStart2.valueAsDate; if(!picked){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; } setWeekByDate(picked); };
    prevWeek.onclick = ()=>{ const d=new Date(CURRENT_WEEK_MON); d.setDate(d.getDate()-7); setWeekByDate(d); };
    nextWeek.onclick = ()=>{ const d=new Date(CURRENT_WEEK_MON); d.setDate(d.getDate()+7); setWeekByDate(d); };

    function setWeekByDate(dateObj){
      CURRENT_WEEK_MON = mondayOf(dateObj);
      CURRENT_WEEK_ID  = weekIdFromDate(CURRENT_WEEK_MON);
      weekStartEl.valueAsDate = CURRENT_WEEK_MON;
      if(weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
      boot();
    }

    // ---------- ë¶„ë¥˜â†’ë˜ì „â†’ë‚œì´ë„ ì—°ë™ ----------
    function refreshDungeons(){
      const cat = catEl.value; dungeonEl.innerHTML='';
      for(const d of DUNGEONS[cat]){ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; dungeonEl.appendChild(o); }
      refreshDiffs();
    }
    function refreshDiffs(){
      const dg = dungeonEl.value; eventDiffEl.innerHTML='';
      (DIFFS[dg]||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; eventDiffEl.appendChild(o); });
    }
    catEl.addEventListener('change', refreshDungeons);
    dungeonEl.addEventListener('change', refreshDiffs);
    refreshDungeons();

    // ì£¼ê°„ ë²”ìœ„ë¡œ íŒŒí‹° ìƒì„± ë‚ ì§œ ì œí•œ
    function syncEventDateRange(){
      const min=new Date(CURRENT_WEEK_MON);
      const max=new Date(CURRENT_WEEK_MON); max.setDate(max.getDate()+6);
      const minStr = `${min.getFullYear()}-${pad2(min.getMonth()+1)}-${pad2(min.getDate())}`;
      const maxStr = `${max.getFullYear()}-${pad2(max.getMonth()+1)}-${pad2(max.getDate())}`;
      eventDateEl.min = minStr; eventDateEl.max = maxStr;
      if(!eventDateEl.value){
        const todayStr = kstYMD();
        eventDateEl.value = (todayStr >= minStr && todayStr <= maxStr) ? todayStr : minStr;
      }
    }-${pad2(min.getMonth()+1)}-${pad2(min.getDate())}`;
      eventDateEl.max = `${max.getFullYear()}-${pad2(max.getMonth()+1)}-${pad2(max.getDate())}`;
      if(!eventDateEl.value){ eventDateEl.valueAsDate = new Date(CURRENT_WEEK_MON); }
    }

    // ---------- íŒŒí‹° ìƒì„± ----------
    createEventBtn.onclick = async ()=>{
      const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
      const sel = new Date(eventDateEl.value); sel.setHours(0,0,0,0);
      const dIdx = Math.floor((sel - CURRENT_WEEK_MON)/86400000);
      if(dIdx<0 || dIdx>6){ alert('ì„ íƒí•œ ë‚ ì§œê°€ í˜„ì¬ ì£¼ê°„(ì›”~ì¼) ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ìƒë‹¨ "í•´ë‹¹ ì£¼ ë³´ê¸°"ë¡œ ì£¼ê°„ì„ ë¨¼ì € ë§ì¶°ì£¼ì„¸ìš”.'); return; }
      const time = eventTimeEl.value || '20:00';
      const cat = catEl.value; const dg = dungeonEl.value; const diff = eventDiffEl.value; const cap = CAP(dg);
      const sid = `${dIdx}-${time}`;

      const slotRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(slotRef);
        let data = snap.exists()? snap.data(): { events: [] };
        const events = Array.isArray(data.events)? data.events: [];
        if(events.length >= 3) throw new Error('í•´ë‹¹ ì‹œê°„ëŒ€ì˜ íŒŒí‹°ê°€ ì´ë¯¸ 3ê°œì…ë‹ˆë‹¤.');
        // ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ë°©ì§€
        for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); }
        const id = 'e'+Date.now()+Math.random().toString(36).slice(2,7);
        events.push({
          id, cat, dg, diff, cap,
          title: `${nick}ì˜ íŒŒí‹°`,
          hostUid: CURRENT_USER.uid,
          hostNick: nick,
          members:[{uid:CURRENT_USER.uid, nick}],
          createdAt: Date.now()
        });
        data.events = events;
        tx.set(slotRef, data);
      }).catch(e=> alert(e.message));

      // ì£¼ê°„ íƒ€ì„ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ìˆëŠ” ì‹œê°„ë§Œ í‘œì‹œ)
      const weekRef = doc(db, 'weeks', CURRENT_WEEK_ID);
      const wSnap = await getDoc(weekRef);
      const times = wSnap.exists()? (wSnap.data().times||[]) : [];
      if(!times.includes(time)){ await setDoc(weekRef, { times: [...times, time] }, { merge:true }); }
    };

    // ---------- ì‹¤ì‹œê°„ êµ¬ë… & ë Œë” ----------
    let unsubWeek = null; let slotUnsubs = []; const SLOT_DATA = new Map();
    function unsubAll(){ if(unsubWeek) try{unsubWeek();}catch(e){} unsubWeek=null; for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs=[]; }

    function boot(){
      unsubAll();
      const sun=new Date(CURRENT_WEEK_MON); sun.setDate(CURRENT_WEEK_MON.getDate()+6);
      weekLabel.textContent = `${CURRENT_WEEK_MON.getFullYear()}-${pad2(CURRENT_WEEK_MON.getMonth()+1)}-${pad2(CURRENT_WEEK_MON.getDate())} ~ ${sun.getFullYear()}-${pad2(sun.getMonth()+1)}-${pad2(sun.getDate())}`;
      if(weekStart2) weekStart2.valueAsDate = CURRENT_WEEK_MON;
      syncEventDateRange();

      const wRef = doc(db, 'weeks', CURRENT_WEEK_ID); setDoc(wRef, { times: [] }, { merge: true });
      // ë¹ˆ times ìë™ ë³µêµ¬(ê¸°ì¡´ ìŠ¬ë¡¯ì—ì„œ ìˆ˜ì§‘)
      hydrateTimesIfMissing(CURRENT_WEEK_ID);
      unsubWeek = onSnapshot(wRef, (snap)=>{
        const times = snap.exists()? (snap.data().times||[]) : [];
        if(!times || times.length===0){ hydrateTimesIfMissing(CURRENT_WEEK_ID); }
        attachSlotListeners(times);
      });
    }

    async function hydrateTimesIfMissing(weekId){
      try{
        const wRef = doc(db,'weeks',weekId); const wSnap = await getDoc(wRef);
        const times = wSnap.exists()? (wSnap.data().times||[]) : [];
        if(times.length>0) return;
        const snaps = await getDocs(collection(db,'weeks',weekId,'slots'));
        const found = new Set();
        snaps.forEach(d=>{ const id=d.id; const parts=id.split('-'); if(parts.length>=2) found.add(parts.slice(1).join('-')); });
        if(found.size>0){ await setDoc(wRef, { times:[...found].sort() }, { merge:true }); }
      }catch(e){ console.warn('hydrateTimesIfMissing failed', e); }
    }

    async function pruneWeekTimeIfEmpty(weekId, time){
      try{
        // í•´ë‹¹ ì£¼ì˜ ê°™ì€ timeì— ëŒ€í•´ ìš”ì¼ 0..6 ìŠ¬ë¡¯ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        for(let d=0; d<7; d++){
          const sRef = doc(db,'weeks',weekId,'slots',`${d}-${time}`);
          const sSnap = await getDoc(sRef);
          if(sSnap.exists()) return; // ì•„ì§ ë‚¨ì•„ìˆìŒ
        }
        // ì „ë¶€ ì—†ìœ¼ë©´ week.timesì—ì„œ ì œê±°
        const wRef = doc(db,'weeks',weekId);
        const wSnap = await getDoc(wRef);
        if(!wSnap.exists()) return;
        const times = wSnap.data().times||[];
        const next = times.filter(t=>t!==time);
        await setDoc(wRef, { times: next }, { merge:true });
      }catch(e){ console.warn('pruneWeekTimeIfEmpty failed', e); }
    }

    function attachSlotListeners(times){
      for(const u of slotUnsubs) try{u();}catch(e){} slotUnsubs = [];
      SLOT_DATA.clear();
      if(!times || times.length===0){ renderEvents(); return; }
      for(let d=0; d<7; d++){
        for(const t of [...times].sort()){
          const sid = `${d}-${t}`;
          const sRef = doc(db, 'weeks', CURRENT_WEEK_ID, 'slots', sid);
          const unsub = onSnapshot(sRef, (snap)=>{
            const data = snap.exists()? snap.data(): { events: [] };
            SLOT_DATA.set(`${d}|${t}`, data.events||[]);
            renderEvents();
          });
          slotUnsubs.push(unsub);
        }
      }
    }

    function labelCat(c){ return c==='abyss'?'ì–´ë¹„ìŠ¤':'ë ˆì´ë“œ'; }
    function labelDungeon(id){ return id==='mas'?'ë§ˆìŠ¤ ë˜ì „':(id==='glas'?'ê¸€ë¼ìŠ¤ê¸°ë¸Œë„¨':'ì„œíë²„ìŠ¤'); }
    function dungeonClass(id){ return id==='mas'?'dg-mas':(id==='glas'?'dg-glas':'dg-succ'); }

    function diffClass(name){
      const n = String(name||'').replace(/\s+/g,'');
      if(n==='ì…ë¬¸') return 'diff-easy';
      if(n==='ì–´ë ¤ì›€') return 'diff-hard';
      if(n==='ë§¤ìš°ì–´ë ¤ì›€') return 'diff-veryhard';
      if(n==='ì…ë¬¸~ì§€ì˜¥6' || n==='ì…ë¶„~ì§€6') return 'diff-pink';
      if(/^ì§€ì˜¥\d+$/.test(n)) return 'diff-veryhard';
      return '';
    }

    function renderEvents(){
      eventsContainer.innerHTML='';
      let any=false;
      for(let d=0; d<7; d++){
        const list=[];
        for(const [key, events] of SLOT_DATA.entries()){
          const [dd, time] = key.split('|');
          if(Number(dd)===d && Array.isArray(events) && events.length>0){ list.push({ time, events }); }
        }
        if(list.length===0) continue; any=true; list.sort((a,b)=> a.time.localeCompare(b.time));
    
        const dayEl=document.createElement('section'); dayEl.className='day';
        const dateObj=new Date(CURRENT_WEEK_MON); dateObj.setDate(CURRENT_WEEK_MON.getDate()+d);
        const dateStr=`${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`;
        dayEl.innerHTML = `<header><h2>${DAYS[d]} <span class="date">${dateStr}</span></h2></header>`;
        const slotsEl=document.createElement('div'); slotsEl.className='slots';
    
        for(const item of list){
          const slotEl=document.createElement('div'); slotEl.className='slot';
          slotEl.innerHTML = `<div class="time">${item.time}</div>`;
          for(const ev of item.events){
            // ê³¼ê±° ë°ì´í„° í˜¸í™˜
            const cat = ev.cat || (ev.type==='abyss'?'abyss':'raid');
            const dg  = ev.dg  || (ev.type==='abyss'?'mas':(ev.type==='glas'?'glas':'succ'));
            const diffCls = diffClass(ev.diff);
            const full = (ev.members?.length||0) >= (ev.cap||4);
            const host = ev.hostNick || (ev.members?.[0]?.nick || 'íŒŒí‹°');
            const title = ev.title || `${host}ì˜ íŒŒí‹°`;
    
            // âœ… ë‚´ê°€ ì°¸ê°€í•œ íŒŒí‹°ì¸ì§€ íŒë³„
            const isMine = !!(CURRENT_USER && (ev.members||[]).some(m=>m.uid===CURRENT_USER.uid));
    
            const names = (ev.members||[]).map(m=>`<span class="chip">${escapeHtml(m.nick)}</span>`).join('') || '<span class="muted">(ë¹„ì–´ìˆìŒ)</span>';
            const evEl=document.createElement('div');
            evEl.className = 'event' + (full?' full':'') + (isMine?' mine':'');
    
            evEl.innerHTML = `
              <div>
                <div class="label">
                  <span class="badge ${cat==='abyss'?'cat-abyss':'cat-raid'}">${labelCat(cat)}</span>
                  <span class="badge ${dungeonClass(dg)}">${labelDungeon(dg)}</span>
                  <span class="badge diff ${diffCls}">${ev.diff}</span>
                  <span class="count">${(ev.members?.length||0)}/${ev.cap||4}</span>
                  ${isMine ? '<span class="badge mine">ë‚´ íŒŒí‹°</span>' : ''}
                </div>
                <div class="title">${escapeHtml(title)}</div>
                <div class="names">${names}</div>
              </div>
              <div class="btns">
                <button class="btn-join">ì°¸ê°€</button>
                <button class="btn-leave">ì·¨ì†Œ</button>
              </div>`;
    
            const joinBtn = evEl.querySelector('.btn-join');
            const leaveBtn = evEl.querySelector('.btn-leave');
    
            // ì°¸ê°€/ì·¨ì†Œ ë²„íŠ¼ ë™ì‘
            joinBtn.addEventListener('click', ()=>{
              const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
              const sid = `${d}-${item.time}`; joinEvent(CURRENT_WEEK_ID, sid, ev.id, ev.cap||4);
            });
            leaveBtn.addEventListener('click', ()=>{
              const sid = `${d}-${item.time}`; leaveEvent(CURRENT_WEEK_ID, sid);
            });
    
            // âœ… ë‚´ íŒŒí‹°ë©´ ì°¸ê°€ ë²„íŠ¼ ë¹„í™œì„±(ì´ë¯¸ ë“¤ì–´ê°€ ìˆìœ¼ë‹ˆ)
            if(isMine){ joinBtn.disabled = true; joinBtn.style.opacity='0.6'; joinBtn.title='ì´ë¯¸ ì°¸ê°€í•œ íŒŒí‹°ì…ë‹ˆë‹¤'; }
            // ì •ì› ì°¼ìœ¼ë©´ ì°¸ê°€ ë²„íŠ¼ ë¹„í™œì„±
            if(full && !isMine){ joinBtn.disabled = true; joinBtn.style.opacity='0.6'; joinBtn.title='ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤'; }
    
            // í˜¸ìŠ¤íŠ¸ ì „ìš© ì‚­ì œ ë²„íŠ¼
            if(ev.hostUid && CURRENT_USER && ev.hostUid===CURRENT_USER.uid){
              const delBtn = document.createElement('button');
              delBtn.className='btn-delete'; delBtn.textContent='ì‚­ì œ';
              evEl.querySelector('.btns').appendChild(delBtn);
              delBtn.addEventListener('click', ()=>{
                const sid = `${d}-${item.time}`; deleteEvent(CURRENT_WEEK_ID, sid, ev.id);
              });
            }
        
            slotEl.appendChild(evEl);
          }
          slotsEl.appendChild(slotEl);
        }
        dayEl.appendChild(slotsEl);
        eventsContainer.appendChild(dayEl);
      }
      emptyHint.style.display = any? 'none':'block';
    }


    async function joinEvent(weekId, sid, eventId, cap){
      const nick=(nickEl.value||'').trim(); if(!nick){ alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); return; }
      const ref = doc(db, 'weeks', weekId, 'slots', sid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        const data = snap.data(); let events = data.events||[];
        // 1) ë™ì‹œê°„ëŒ€ ì¤‘ë³µ ë°©ì§€
        for(const e of events){ e.members = (e.members||[]).filter(m=>m.uid!==CURRENT_USER.uid); }
        // 2) ëŒ€ìƒ ì´ë²¤íŠ¸ì— ë‚˜ ì¶”ê°€
        const target = events.find(e=>e.id===eventId);
        if(!target) throw new Error('í•´ë‹¹ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        if((target.members?.length||0) >= (target.cap||cap)) throw new Error('ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
        target.members = [...(target.members||[]), { uid: CURRENT_USER.uid, nick }];
        // 3) ë©¤ë²„ 0 ì´ë²¤íŠ¸ ì œê±°
        events = events.filter(e => (e.members?.length||0) > 0);
        // 4) ë¬¸ì„œ ê°±ì‹ 
        if(events.length===0){ tx.delete(ref); } else { tx.set(ref, { events }, { merge:true }); }
      }).catch(e=>alert(e.message));
      // 5) week.times ì •ë¦¬
      const time = sid.split('-').slice(1).join('-');
      await pruneWeekTimeIfEmpty(weekId, time);
    }

    async function leaveEvent(weekId, sid){
      const ref = doc(db, 'weeks', weekId, 'slots', sid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref); if(!snap.exists()) return;
        let events = (snap.data().events||[]);
        // ë‚´ uid ì œê±°
        let touched=false;
        for(const e of events){
          const before=e.members||[];
          const after=before.filter(m=>m.uid!==CURRENT_USER.uid);
          if(after.length!==before.length){ e.members=after; touched=true; }
        }
        // ë©¤ë²„ 0 ì´ë²¤íŠ¸ ì‚­ì œ
        events = events.filter(e => (e.members?.length||0) > 0);
        if(!touched && events.length>0) return; // ë³€ê²½ ì—†ìŒ
        if(events.length===0){ tx.delete(ref); } else { tx.set(ref, { events }, { merge:true }); }
      }).catch(e=>console.warn(e));
      // ì£¼ê°„ timesì—ì„œ ë¹„ì—ˆìœ¼ë©´ ì œê±°
      const time = sid.split('-').slice(1).join('-');
      await pruneWeekTimeIfEmpty(weekId, time);
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
      }[c]));
    }[c]));
    }

    async function deleteEvent(weekId, sid, eventId){
      const ref = doc(db,'weeks',weekId,'slots',sid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref); if(!snap.exists()) return;
        let events = (snap.data().events||[]).filter(e=>e.id!==eventId);
        if(events.length===0){ tx.delete(ref); } else { tx.set(ref,{ events },{ merge:true }); }
      }).catch(e=>alert(e.message));
      const time = sid.split('-').slice(1).join('-');
      await pruneWeekTimeIfEmpty(weekId, time);
    }
  </script>
</body>
</html>
